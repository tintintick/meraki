{{ 'responsive-scale.css' | asset_url | stylesheet_tag }}
{{ 'custom-video.css' | asset_url | stylesheet_tag }}

<div class="custom-video design-scale" data-section-id="{{ section.id }}">
  <div class="video-container">
    <!-- Video Header -->
    <div class="video-header">
      <!-- Title Wrapper -->
      <div class="video-title-wrapper">
        <div class="video-titles-track">
          {% for block in section.blocks %}
            <div class="video-title">{{ block.settings.title }}</div>
          {% endfor %}
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="video-switch">
        <!-- Previous Button -->
        <button class="nav-button nav-prev" data-direction="prev" aria-label="Previous Video">
          <img src="{{ 'icon-previous.svg' | asset_url }}" alt="Previous" class="nav-icon nav-icon-active">
          <img src="{{ 'icon-previous-disable.svg' | asset_url }}" alt="Previous (Disabled)" class="nav-icon nav-icon-disable">
        </button>

        <!-- Next Button -->
        <button class="nav-button nav-next" data-direction="next" aria-label="Next Video">
          <img src="{{ 'icon-next.svg' | asset_url }}" alt="Next" class="nav-icon nav-icon-active">
          <img src="{{ 'icon-next-disable.svg' | asset_url }}" alt="Next (Disabled)" class="nav-icon nav-icon-disable">
        </button>
      </div>
    </div>

    <!-- Video Player Container -->
    <div class="video-player-container">
      <div class="video-players-track">
        {% for block in section.blocks %}
          <div class="video-player-item">
            {%- if block.settings.video != blank -%}
              {{
                block.settings.video
                | video_tag:
                  image_size: '1340x',
                  autoplay: false,
                  loop: false,
                  controls: true,
                  muted: true,
                  loading: 'lazy'
              }}
            {%- elsif block.settings.video_src != blank -%}
              <video
                src="{{ block.settings.video_src | asset_url }}"
                controls
                muted
                loading="lazy"
              ></video>
            {%- endif -%}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  function initVideo() {
    const section = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!section) {
      requestAnimationFrame(initVideo);
      return;
    }

    const prevBtn = section.querySelector('.nav-prev');
    const nextBtn = section.querySelector('.nav-next');
    const titleWrapper = section.querySelector('.video-title-wrapper');
    const playerContainer = section.querySelector('.video-player-container');
    const videos = Array.from(section.querySelectorAll('video'));
    const totalVideos = videos.length;

    if (!prevBtn || !nextBtn || !titleWrapper || !playerContainer || totalVideos === 0) {
      return;
    }

    let currentIndex = 0;

    // Get scale factor from CSS variable
    function getScaleFactor() {
      const value = getComputedStyle(section).getPropertyValue('--scale-factor-mobile').trim();
      return parseFloat(value) || 1;
    }

    // Get item widths from CSS variables
    function getItemWidths() {
      const titleWidth = parseFloat(getComputedStyle(section).getPropertyValue('--title-width').trim());
      const playerWidth = parseFloat(getComputedStyle(section).getPropertyValue('--player-width').trim());
      const scaleFactor = getScaleFactor();
      return {
        titleWidth: titleWidth * scaleFactor,
        playerWidth: playerWidth * scaleFactor
      };
    }

    // Update button states
    function updateButtons() {
      prevBtn.classList.toggle('disabled', currentIndex === 0);
      nextBtn.classList.toggle('disabled', currentIndex >= totalVideos - 1);
    }

    // Pause non-current videos
    function pauseNonCurrentVideos() {
      videos.forEach((video, vidIndex) => {
        if (vidIndex !== currentIndex) {
          video.pause();
        }
      });
    }

    // Scroll to index
    function scrollToIndex(index) {
      if (index < 0 || index >= totalVideos) {
        return;
      }

      const widths = getItemWidths();

      // Scroll both containers
      titleWrapper.scrollLeft = index * widths.titleWidth;
      playerContainer.scrollLeft = index * widths.playerWidth;

      currentIndex = index;
      updateButtons();
      pauseNonCurrentVideos();
    }

    // Detect scroll position and update index
    function handleScroll() {
      const widths = getItemWidths();
      const scrolledIndex = Math.round(playerContainer.scrollLeft / widths.playerWidth);

      if (scrolledIndex !== currentIndex) {
        currentIndex = scrolledIndex;
        updateButtons();
        pauseNonCurrentVideos();

        // Sync title scroll
        titleWrapper.scrollLeft = currentIndex * widths.titleWidth;
      }
    }

    // Initialize
    updateButtons();

    // Button click handlers
    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        scrollToIndex(currentIndex - 1);
      }
    });

    nextBtn.addEventListener('click', () => {
      if (currentIndex < totalVideos - 1) {
        scrollToIndex(currentIndex + 1);
      }
    });

    // Listen to scroll events
    playerContainer.addEventListener('scroll', handleScroll, { passive: true });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initVideo);
  } else {
    initVideo();
  }
})();
</script>

{% schema %}
{
  "name": "Custom Video",
  "blocks": [
    {
      "type": "video_item",
      "name": "Video Item",
      "settings": [
        {
          "type": "textarea",
          "id": "title",
          "label": "Title",
          "default": "The Choice of Coffee Professionals"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video (Shopify Upload)"
        },
        {
          "type": "text",
          "id": "video_src",
          "label": "Video Source (Local Asset)",
          "info": "Enter the filename of a video in your assets folder (e.g., 'video.mp4')"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Video",
      "blocks": [
        {
          "type": "video_item",
          "settings": {
            "title": "The Choice of Coffee Professionals"
          }
        }
      ]
    }
  ]
}
{% endschema %}
