{{ 'custom-video.css' | asset_url | stylesheet_tag }}

<div class="custom-video design-scale" data-section-id="{{ section.id }}">
  <div class="video-container">
    <!-- Video Header -->
    <div class="video-header">
      <!-- Section Title -->
      <h2 class="video-section-title">The Choice of Coffee Professionals</h2>

      <!-- Navigation Buttons -->
      <div class="video-switch">
        <!-- Previous Button -->
        <button class="nav-button nav-prev" data-direction="prev" aria-label="Previous Video">
          <img src="{{ 'icon-previous.svg' | asset_url }}" alt="Previous" class="nav-icon nav-icon-active">
          <img src="{{ 'icon-previous-disable.svg' | asset_url }}" alt="Previous (Disabled)" class="nav-icon nav-icon-disable">
        </button>

        <!-- Next Button -->
        <button class="nav-button nav-next" data-direction="next" aria-label="Next Video">
          <img src="{{ 'icon-next.svg' | asset_url }}" alt="Next" class="nav-icon nav-icon-active">
          <img src="{{ 'icon-next-disable.svg' | asset_url }}" alt="Next (Disabled)" class="nav-icon nav-icon-disable">
        </button>
      </div>
    </div>

    <!-- Video Player Container -->
    <div class="video-player-container">
      <div class="video-players-track">
        {% for block in section.blocks %}
          <div class="video-player-item" data-video-wrapper>
            {%- if block.settings.video != blank -%}
              {{
                block.settings.video
                | video_tag:
                  image_size: '1340x',
                  autoplay: false,
                  loop: false,
                  controls: false,
                  muted: true,
                  loading: 'lazy',
                  class: 'video-element'
              }}
            {%- else -%}
              <video
                class="video-element"
                src="{{ 'video/' | append: forloop.index | append: '.mp4' | asset_url }}"
                muted
                loading="lazy"
                playsinline
              ></video>
            {%- endif -%}

            <!-- Play Button -->
            <button class="video-play-button" data-play-button>
              <img src="{{ 'video/play.svg' | asset_url }}" alt="Play" />
            </button>

            <!-- Gradient Mask -->
            <div class="video-gradient-mask" data-video-mask>
              <img src="{{ 'video/video-gradient-mask.png' | asset_url }}" alt="" />
            </div>

            <!-- Video Info -->
            <div class="video-info" data-video-info>
              {%- if block.settings.creator_avatar != blank -%}
                <img
                  class="creator-avatar"
                  src="{{ block.settings.creator_avatar | image_url: width: 160 }}"
                  alt="{{ block.settings.creator_name | escape }}"
                />
              {%- else -%}
                <img
                  class="creator-avatar"
                  src="{{ 'video/avatar' | append: forloop.index | append: '.png' | asset_url }}"
                  alt="{{ block.settings.creator_name | escape }}"
                />
              {%- endif -%}
              <div class="video-metadata">
                <p class="creator-name">{{ block.settings.creator_name }}</p>
                <p class="video-title">{{ block.settings.title }}</p>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  function initVideo() {
    const section = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!section) {
      requestAnimationFrame(initVideo);
      return;
    }

    const prevBtn = section.querySelector('.nav-prev');
    const nextBtn = section.querySelector('.nav-next');
    const playerContainer = section.querySelector('.video-player-container');
    const videos = Array.from(section.querySelectorAll('video'));
    const totalVideos = videos.length;

    if (!prevBtn || !nextBtn || !playerContainer || totalVideos === 0) {
      return;
    }

    let currentIndex = 0;

    // Get scale factor from CSS variable
    function getScaleFactor() {
      const value = getComputedStyle(section).getPropertyValue('--scale-factor-mobile').trim();
      return parseFloat(value) || 1;
    }

    // Get player width from CSS variable
    function getPlayerWidth() {
      const playerWidth = parseFloat(getComputedStyle(section).getPropertyValue('--player-width').trim());
      const scaleFactor = getScaleFactor();
      return playerWidth * scaleFactor;
    }

    // Update button states
    function updateButtons() {
      prevBtn.classList.toggle('disabled', currentIndex === 0);
      nextBtn.classList.toggle('disabled', currentIndex >= totalVideos - 1);
    }

    // Pause non-current videos and reset UI
    function pauseNonCurrentVideos() {
      videos.forEach((video, vidIndex) => {
        if (vidIndex !== currentIndex) {
          video.pause();
          const wrapper = video.closest('[data-video-wrapper]');
          if (wrapper) {
            wrapper.classList.remove('is-playing');
            video.removeAttribute('controls');
          }
        }
      });
    }

    // Initialize video controls for each video
    videos.forEach((video) => {
      const wrapper = video.closest('[data-video-wrapper]');
      const playButton = wrapper.querySelector('[data-play-button]');

      if (!wrapper || !playButton) return;

      // Initially hide controls
      video.removeAttribute('controls');

      // Play button click
      playButton.addEventListener('click', () => {
        video.play();
      });

      // When video starts playing
      video.addEventListener('play', () => {
        video.setAttribute('controls', '');
        wrapper.classList.add('is-playing');
      });

      // When video pauses
      video.addEventListener('pause', () => {
        video.removeAttribute('controls');
        wrapper.classList.remove('is-playing');
      });

      // When video ends
      video.addEventListener('ended', () => {
        video.removeAttribute('controls');
        wrapper.classList.remove('is-playing');
      });
    });

    // Scroll to index
    function scrollToIndex(index) {
      if (index < 0 || index >= totalVideos) {
        return;
      }

      const playerWidth = getPlayerWidth();
      playerContainer.scrollLeft = index * playerWidth;

      currentIndex = index;
      updateButtons();
      pauseNonCurrentVideos();
    }

    // Detect scroll position and update index
    function handleScroll() {
      const playerWidth = getPlayerWidth();
      const scrolledIndex = Math.round(playerContainer.scrollLeft / playerWidth);

      if (scrolledIndex !== currentIndex) {
        currentIndex = scrolledIndex;
        updateButtons();
        pauseNonCurrentVideos();
      }
    }

    // Initialize
    updateButtons();

    // Button click handlers
    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        scrollToIndex(currentIndex - 1);
      }
    });

    nextBtn.addEventListener('click', () => {
      if (currentIndex < totalVideos - 1) {
        scrollToIndex(currentIndex + 1);
      }
    });

    // Listen to scroll events
    playerContainer.addEventListener('scroll', handleScroll, { passive: true });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initVideo);
  } else {
    initVideo();
  }
})();
</script>

{% schema %}
{
  "name": "Custom Video",
  "blocks": [
    {
      "type": "video_item",
      "name": "Video Item",
      "settings": [
        {
          "type": "textarea",
          "id": "title",
          "label": "Video Title"
        },
        {
          "type": "text",
          "id": "creator_name",
          "label": "Creator Name"
        },
        {
          "type": "image_picker",
          "id": "creator_avatar",
          "label": "Creator Avatar"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video (Shopify Upload)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Video",
      "blocks": [
        {
          "type": "video_item",
          "settings": {
            "title": "The Choice of Coffee Professionals"
          }
        }
      ]
    }
  ]
}
{% endschema %}
