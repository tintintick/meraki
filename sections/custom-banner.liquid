{{ 'custom-banner-new.css' | asset_url | stylesheet_tag }}

<div class="custom-banner design-scale" data-banner-section>
  {%- if section.blocks.size > 0 -%}
    <div class="banner-slides">
      {%- for block in section.blocks -%}
        {%- assign slide_index = forloop.index -%}
        <div
          class="banner-slide {% if forloop.first %}active{% endif %}"
          data-slide="{{ slide_index }}"
          {{ block.shopify_attributes }}
        >
          <!-- Image Container -->
          <div class="banner-image-wrapper">
            {%- if block.settings.mobile_image != blank -%}
              <img
                class="banner-image banner-image-mobile"
                src="{{ block.settings.mobile_image | image_url: width: 917 }}"
                alt="{{ block.settings.heading | escape }}"
                loading="lazy"
              >
            {%- else -%}
              {%- assign default_mobile_image = 'banner-mobile.jpg' -%}
              {%- if forloop.index == 2 -%}
                {%- assign default_mobile_image = 'banner-mobile-1.jpg' -%}
              {%- endif -%}
              <img
                class="banner-image banner-image-mobile"
                src="{{ default_mobile_image | asset_url }}"
                alt="{{ block.settings.heading | default: 'Banner' }}"
                loading="lazy"
              >
            {%- endif -%}

            {%- if block.settings.desktop_image != blank -%}
              <img
                class="banner-image banner-image-desktop"
                src="{{ block.settings.desktop_image | image_url: width: 1920 }}"
                alt="{{ block.settings.heading | escape }}"
                loading="lazy"
              >
            {%- else -%}
              <img
                class="banner-image banner-image-desktop"
                src="{{ 'banner-pc.jpeg' | asset_url }}"
                alt="{{ block.settings.heading | default: 'Banner' }}"
                loading="lazy"
              >
            {%- endif -%}
          </div>

          <!-- Content Container -->
          <div class="banner-content">
            <!-- Heading - Mobile -->
            {%- if block.settings.heading_mobile != blank -%}
              <div class="banner-heading banner-heading--mobile">{{ block.settings.heading_mobile }}</div>
            {%- elsif block.settings.heading != blank -%}
              <div class="banner-heading banner-heading--mobile">{{ block.settings.heading }}</div>
            {%- endif -%}

            <!-- Heading - Desktop -->
            {%- if block.settings.heading_desktop != blank -%}
              <div class="banner-heading banner-heading--desktop">{{ block.settings.heading_desktop }}</div>
            {%- elsif block.settings.heading != blank -%}
              <div class="banner-heading banner-heading--desktop">{{ block.settings.heading }}</div>
            {%- endif -%}

            {%- if block.settings.button_text -%}
              <a
                href="{{ block.settings.button_link | default: '/products/meraki-espresso-machine' }}"
                class="banner-button"
              >
                {{ block.settings.button_text }}
              </a>
            {%- endif -%}
          </div>
        </div>
      {%- endfor -%}
    </div>

    <!-- Indicators Navigation -->
    {%- if section.blocks.size > 1 -%}
      <div class="banner-indicators">
        {%- for block in section.blocks -%}
          <button
            class="banner-indicator {% if forloop.first %}active{% endif %}"
            data-slide="{{ forloop.index }}"
            aria-label="Go to slide {{ forloop.index }}"
          ></button>
        {%- endfor -%}
      </div>
    {%- endif -%}
  {%- endif -%}
</div>

<script>
  (function() {
    // Initialize banner carousel
    function initBanner() {
      const bannerSection = document.querySelector('[data-banner-section]');
      if (!bannerSection) {
        // Retry if element not yet loaded
        setTimeout(initBanner, 100);
        return;
      }

      const slides = bannerSection.querySelectorAll('.banner-slide');
      const indicators = bannerSection.querySelectorAll('.banner-indicator');
      let currentIndex = 0;
      let autoRotateTimer = null;
      let touchStartX = 0;
      let touchEndX = 0;

      if (slides.length === 0) return;

      function goToSlide(index) {
        // Handle wraparound
        if (index < 0) index = slides.length - 1;
        if (index >= slides.length) index = 0;

        // Remove active class from all slides and indicators
        slides.forEach(slide => slide.classList.remove('active'));
        indicators.forEach(indicator => indicator.classList.remove('active'));

        // Add active class to current slide and indicator
        slides[index].classList.add('active');
        indicators[index]?.classList.add('active');

        currentIndex = index;

        // Restart auto-rotate after user interaction
        restartAutoRotate();
      }

      function startAutoRotate() {
        {%- if section.settings.auto_rotate -%}
          if (autoRotateTimer) clearInterval(autoRotateTimer);
          autoRotateTimer = setInterval(() => {
            goToSlide(currentIndex + 1);
          }, {{ section.settings.rotation_speed | default: 5000 }});
        {%- endif -%}
      }

      function stopAutoRotate() {
        {%- if section.settings.auto_rotate -%}
          if (autoRotateTimer) {
            clearInterval(autoRotateTimer);
            autoRotateTimer = null;
          }
        {%- endif -%}
      }

      function restartAutoRotate() {
        stopAutoRotate();
        startAutoRotate();
      }

      // Indicator click handlers
      indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => {
          stopAutoRotate();
          goToSlide(index);
        });
      });

      // Touch swipe handlers - for mobile sliding
      bannerSection.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        stopAutoRotate();
      }, false);

      bannerSection.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        const swipeDistance = touchStartX - touchEndX;

        // Swipe left (swipeDistance > 0) - next slide
        if (swipeDistance > 50) {
          goToSlide(currentIndex + 1);
        }
        // Swipe right (swipeDistance < 0) - previous slide
        else if (swipeDistance < -50) {
          goToSlide(currentIndex - 1);
        } else {
          // Minor swipe, resume auto-rotate
          startAutoRotate();
        }
      }, false);

      // Initialize auto-rotate
      startAutoRotate();
    }

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initBanner);
    } else {
      initBanner();
    }
  })();
</script>

{% schema %}
{
  "name": "Custom Banner",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "auto_rotate",
      "label": "Auto-rotate slides",
      "default": true
    },
    {
      "type": "range",
      "id": "rotation_speed",
      "min": 2000,
      "max": 9000,
      "step": 500,
      "unit": "ms",
      "label": "Rotation speed",
      "default": 5000
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "type": "image_picker",
          "id": "mobile_image",
          "label": "Mobile image (750px)"
        },
        {
          "type": "image_picker",
          "id": "desktop_image",
          "label": "Desktop image (1920px)"
        },
        {
          "type": "header",
          "content": "Mobile Content"
        },
        {
          "type": "textarea",
          "id": "heading_mobile",
          "label": "Heading text (Mobile)",
          "default": "Redefining Espresso\nat home"
        },
        {
          "type": "header",
          "content": "Desktop Content"
        },
        {
          "type": "textarea",
          "id": "heading_desktop",
          "label": "Heading text (Desktop)",
          "info": "Use \\n for line breaks",
          "default": "Redefining Espresso\nat home"
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Button text",
          "default": "Shop Now"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "Button link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Banner",
      "blocks": [
        {
          "type": "slide",
          "settings": {
            "heading_mobile": "Redefining Espresso\nat home",
            "heading_desktop": "Redefining Espresso\nat home",
            "button_text": "Shop Now"
          }
        }
      ]
    }
  ]
}
{% endschema %}
