{{ 'meraki-common.css' | asset_url | stylesheet_tag }}
{{ 'meraki-video.css' | asset_url | stylesheet_tag }}
<script src="{{ 'lite-youtube.js' | asset_url }}" defer></script>

<!-- Preconnect to YouTube -->
<link rel="preconnect" href="https://www.youtube.com">
<link rel="preconnect" href="https://i.ytimg.com">

<div class="meraki-video design-scale" data-section-id="{{ section.id }}">
  <div class="video-container">
    <!-- Video Header -->
    <div class="video-header">
      <!-- Section Title -->
      <h2 class="video-section-title">The Choice of Coffee Professionals</h2>

      <!-- Navigation Buttons -->
      <div class="video-switch">
        <!-- Previous Button -->
        <button class="nav-button nav-prev" data-direction="prev" aria-label="Previous Video">
          <img src="{{ 'icon-previous.svg' | asset_url }}" alt="Previous" class="nav-icon nav-icon-active">
          <img src="{{ 'icon-previous-disable.svg' | asset_url }}" alt="Previous (Disabled)" class="nav-icon nav-icon-disable">
        </button>

        <!-- Next Button -->
        <button class="nav-button nav-next" data-direction="next" aria-label="Next Video">
          <img src="{{ 'icon-next.svg' | asset_url }}" alt="Next" class="nav-icon nav-icon-active">
          <img src="{{ 'icon-next-disable.svg' | asset_url }}" alt="Next (Disabled)" class="nav-icon nav-icon-disable">
        </button>
      </div>
    </div>

    <!-- Video Player Container -->
    <div class="video-player-container">
      <div class="video-players-track">
        <div class="video-player-item video-spacer">&nbsp;</div>
        {% for block in section.blocks %}
          <div class="video-player-item" data-video-wrapper data-youtube-id="{{ block.settings.youtube_id }}">
            {%- if block.settings.youtube_id != blank -%}
              <!-- YouTube Embed -->
              <lite-youtube videoid="{{ block.settings.youtube_id }}" class="video-element"></lite-youtube>
            {%- elsif block.settings.video != blank -%}
              <!-- Fallback: Shopify Video Upload -->
              {{
                block.settings.video
                | video_tag:
                  image_size: '1340x',
                  autoplay: false,
                  loop: false,
                  controls: false,
                  muted: true,
                  loading: 'lazy',
                  class: 'video-element'
              }}
              <!-- Play Button -->
              <button class="video-play-button" data-play-button>
                <img src="{{ 'video/play.svg' | asset_url }}" alt="Play" />
              </button>
            {%- else -%}
              <!-- Placeholder -->
              <div class="video-placeholder video-element">
                <p>No video configured</p>
              </div>
            {%- endif -%}

            <!-- Gradient Mask (for non-YouTube videos) -->
            {%- if block.settings.youtube_id == blank -%}
              <div class="video-gradient-mask" data-video-mask>
                <img src="{{ 'video/video-gradient-mask.png' | asset_url }}" alt="" />
              </div>
            {%- endif -%}

            <!-- Video Info -->
            <div class="video-info" data-video-info>
              {%- if block.settings.creator_avatar != blank -%}
                <img
                  class="creator-avatar"
                  src="{{ block.settings.creator_avatar | image_url: width: 160 }}"
                  alt="{{ block.settings.creator_name | escape }}"
                  width="80"
                  height="80"
                />
              {%- else -%}
                <img
                  class="creator-avatar"
                  src="{{ 'video/avatar' | append: forloop.index | append: '.png' | asset_url }}"
                  alt="{{ block.settings.creator_name | escape }}"
                  width="80"
                  height="80"
                />
              {%- endif -%}
              <div class="video-metadata">
                <p class="creator-name">{{ block.settings.creator_name }}</p>
                <p class="video-title">{{ block.settings.title }}</p>
              </div>
            </div>
          </div>
        {% endfor %}
        <div class="video-player-item video-spacer">&nbsp;</div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  function initVideo() {
    const section = document.querySelector('.meraki-video[data-section-id="{{ section.id }}"]');
    if (!section) {
      requestAnimationFrame(initVideo);
      return;
    }

    if (!window.MerakiCarousel) {
      console.error('MerakiCarousel not loaded');
      return;
    }

    const track = section.querySelector('.video-players-track');
    const videoWrappers = Array.from(section.querySelectorAll('[data-video-wrapper]'));
    const prevBtn = section.querySelector('.nav-prev');
    const nextBtn = section.querySelector('.nav-next');

    if (!track || !videoWrappers.length || !prevBtn || !nextBtn) {
      return;
    }

    // 获取缩放因子
    function getScaleFactor() {
      const isDesktop = window.innerWidth >= 990;
      const varName = isDesktop ? '--scale-factor-desktop' : '--scale-factor-mobile';
      const value = getComputedStyle(section).getPropertyValue(varName).trim();
      return parseFloat(value) || 1;
    }

    // 获取 gap
    function getGap() {
      const isDesktop = window.innerWidth >= 990;
      if (isDesktop) {
        const gapValue = getComputedStyle(section).getPropertyValue('--player-track-gap-desktop').trim();
        const scaleFactor = getScaleFactor();
        return parseFloat(gapValue) * scaleFactor || 0;
      }
      return 0; // Mobile has no gap
    }

    // 获取播放器宽度
    function getPlayerWidth() {
      const firstItem = section.querySelector('.video-player-item:not(.video-spacer)');
      if (firstItem) {
        return firstItem.offsetWidth;
      }
      return 0;
    }

    // 获取初始偏移（1920设计稿中向左偏移1020px）
    function getInitialOffset() {
      if (window.innerWidth >= 990) {
        const scaleFactor = getScaleFactor();
        return -1020 * scaleFactor;
      }
      return 0;
    }

    // 停止所有正在播放的视频
    function stopAllVideos() {
      videoWrappers.forEach((wrapper) => {
        // 只处理正在播放的视频
        if (!wrapper.classList.contains('is-playing')) return;
        
        // Stop YouTube videos
        const liteYouTube = wrapper.querySelector('lite-youtube');
        if (liteYouTube && liteYouTube.classList.contains('lyt-activated')) {
          if (typeof liteYouTube.reset === 'function') {
            liteYouTube.reset();
          }
          wrapper.classList.remove('is-playing');
        }

        // Stop regular video elements
        const video = wrapper.querySelector('video');
        if (video && !video.paused) {
          video.pause();
          video.currentTime = 0;
          wrapper.classList.remove('is-playing');
          video.removeAttribute('controls');
        }
      });
    }

    // 初始化视频控制（非 YouTube 视频）
    videoWrappers.forEach((wrapper) => {
      const video = wrapper.querySelector('video');
      if (!video) return;

      const playButton = wrapper.querySelector('[data-play-button]');
      if (!playButton) return;

      video.removeAttribute('controls');

      playButton.addEventListener('click', () => {
        video.play();
      });

      video.addEventListener('play', () => {
        video.setAttribute('controls', '');
        wrapper.classList.add('is-playing');
      });

      video.addEventListener('pause', () => {
        video.removeAttribute('controls');
        wrapper.classList.remove('is-playing');
      });

      video.addEventListener('ended', () => {
        video.removeAttribute('controls');
        wrapper.classList.remove('is-playing');
      });
    });

    // 监听 YouTube 激活事件
    section.addEventListener('lyt-activated', (e) => {
      const activatedElement = e.target;
      if (activatedElement && activatedElement.tagName === 'LITE-YOUTUBE') {
        const wrapper = activatedElement.closest('[data-video-wrapper]');
        if (wrapper) {
          wrapper.classList.add('is-playing');
        }
      }
    });

    // 使用通用 Carousel 组件
    new MerakiCarousel({
      container: section,
      track: track,
      items: videoWrappers,
      prevButton: prevBtn,
      nextButton: nextBtn,
      
      // 使用 slide-fade 模式（滑动+淡化）
      mode: 'slide-fade',
      
      // 播放器宽度 + gap
      itemWidth: () => getPlayerWidth() + getGap(),
      
      // Gap（桌面端40px，移动端0）
      gap: 0,  // gap已包含在itemWidth中
      
      // 初始偏移（抵消 spacer）
      initialOffset: () => getInitialOffset(),
      
      // 移动端和桌面端都启用
      desktopOnly: false,
      
      // 启用 Touch 手势（移动端横向划动）
      enableTouch: true,
      touchThreshold: 80,
      
      // 切换后停止所有视频
      onAfterChange: function() {
        stopAllVideos();
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initVideo);
  } else {
    initVideo();
  }
})();
</script>

{% schema %}
{
  "name": "Meraki Video",
  "blocks": [
    {
      "type": "video_item",
      "name": "Video Item",
      "settings": [
        {
          "type": "text",
          "id": "youtube_id",
          "label": "YouTube Video ID",
          "info": "Enter the YouTube video ID (e.g., dQw4w9WgXcQ from https://www.youtube.com/watch?v=dQw4w9WgXcQ)"
        },
        {
          "type": "textarea",
          "id": "title",
          "label": "Video Title"
        },
        {
          "type": "text",
          "id": "creator_name",
          "label": "Creator Name"
        },
        {
          "type": "image_picker",
          "id": "creator_avatar",
          "label": "Creator Avatar"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video (Shopify Upload - Fallback)",
          "info": "Only used if YouTube ID is not provided"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Meraki Video",
      "blocks": [
        {
          "type": "video_item",
          "settings": {
            "title": "The Choice of Coffee Professionals"
          }
        }
      ]
    }
  ]
}
{% endschema %}
