{{ 'meraki-common.css' | asset_url | stylesheet_tag }}
{{ 'meraki-prs.css' | asset_url | stylesheet_tag }}

<div class="meraki-prs design-scale" data-section-id="{{ section.id }}">
  <div class="prs-wrapper">
    <!-- PR Container -->
    <div class="pr-container">
      <div class="prs-track">
        {% for block in section.blocks %}
          <div class="pr-card" data-block-id="{{ block.id }}">
            <!-- PR Icon -->
            <div class="pr-icon">
              {%- if block.settings.icon != blank -%}
                <img
                  src="{{ block.settings.icon | image_url: width: 150 }}"
                  alt="PR Logo {{ forloop.index }}"
                  loading="lazy"
                >
              {%- else -%}
                <img
                  src="{{ 'prs/pr' | append: forloop.index | append: '.png' | asset_url }}"
                  alt="PR Logo {{ forloop.index }}"
                  loading="lazy"
                >
              {%- endif -%}
            </div>

            <!-- PR Content -->
            <div class="pr-content">
              <p class="pr-text">{{ block.settings.text }}</p>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Navigation Icons -->
    <div class="icon-group">
      <!-- Previous Button -->
      <button class="nav-button nav-prev" data-direction="prev" aria-label="Previous PR">
        <img src="{{ 'icon-previous.svg' | asset_url }}" alt="Previous" class="nav-icon nav-icon-active">
        <img src="{{ 'icon-previous-disable.svg' | asset_url }}" alt="Previous (Disabled)" class="nav-icon nav-icon-disable">
      </button>

      <!-- Next Button -->
      <button class="nav-button nav-next" data-direction="next" aria-label="Next PR">
        <img src="{{ 'icon-next.svg' | asset_url }}" alt="Next" class="nav-icon nav-icon-active">
        <img src="{{ 'icon-next-disable.svg' | asset_url }}" alt="Next (Disabled)" class="nav-icon nav-icon-disable">
      </button>
    </div>
  </div>
</div>

<script>
(function() {
  function initPRs() {
    const section = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!section) {
      requestAnimationFrame(initPRs);
      return;
    }

    // 检查 MerakiCarousel 是否已加载
    if (!window.MerakiCarousel) {
      console.error('MerakiCarousel not loaded');
      return;
    }

    const prsTrack = section.querySelector('.prs-track');
    const cards = section.querySelectorAll('.pr-card');
    const prevBtn = section.querySelector('.nav-prev');
    const nextBtn = section.querySelector('.nav-next');

    if (!prsTrack || !cards.length || !prevBtn || !nextBtn) {
      return;
    }

    // 使用通用 Carousel 组件
    new MerakiCarousel({
      container: section,
      track: prsTrack,
      items: cards,
      prevButton: prevBtn,
      nextButton: nextBtn,
      
      // 移动端和桌面端都启用
      desktopOnly: false,
      
      // 响应式模式切换
      mode: window.innerWidth < 990 ? 'stack-fade' : 'slide',
      
      // 尺寸配置（根据缩放因子）
      itemWidth: function(scale) {
        if (window.innerWidth < 990) {
          return 670 * scale;  // 移动端
        }
        return (410 + 25) * scale;  // 桌面端（card宽度 + gap）
      },
      
      gap: window.innerWidth < 990 ? 0 : 25,
      
      // 按钮逻辑
      itemsVisible: function() {
        return window.innerWidth < 990 ? 1 : 3;
      },
      
      // Touch 支持
      enableTouch: true,
      touchThreshold: 80,
      
      // Resize 处理
      onResize: function() {
        this.mode = window.innerWidth < 990 ? 'stack-fade' : 'slide';
        this.reinit();
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPRs);
  } else {
    initPRs();
  }
})();
</script>

{% schema %}
{
  "name": "Meraki PRs",
  "blocks": [
    {
      "type": "pr_card",
      "name": "PR Card",
      "settings": [
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Icon"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "Text",
          "default": "\"\""
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Meraki PRs",
      "blocks": [
        {
          "type": "pr_card",
          "settings": {
            "text": "\"This is a real game-changer! And to be honest, it completely blew our minds the first time we tried it, because the espresso was just so on point.\""
          }
        },
        {
          "type": "pr_card",
          "settings": {
            "text": "\"It rivaled the much more expensive machines I was used to working with at my coffee jobs, creating a nice layer of crema and extracting the floral notes of the coffee.\""
          }
        },
        {
          "type": "pr_card",
          "settings": {
            "text": "\"This linear approach optimizes and simplifies your coffee-making 'workflow' while still preserving the artistry and authenticity of barista-crafted espresso.\""
          }
        }
      ]
    }
  ]
}
{% endschema %}
