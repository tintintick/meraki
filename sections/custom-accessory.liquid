{{ 'custom-accessory.css' | asset_url | stylesheet_tag }}

<div class="custom-accessory design-scale" data-section-id="{{ section.id }}">
  <!-- Content Container -->
  <div class="content-container">
    <h2 class="section-title">{{ section.settings.title }}</h2>
    <p class="section-description">{{ section.settings.description }}</p>
  </div>

  <!-- Accessory Wrapper -->
  <div class="accessory-wrapper">
    <!-- Images Container -->
    <div class="accessory-imgs">
      <div class="accessory-imgs-track">
        <!-- Left Spacer -->
        <div class="accessory-img-spacer">&nbsp;</div>

        {% for block in section.blocks %}
          <div class="accessory-img {% if forloop.first %}is-center{% endif %}">
            {%- if block.settings.link != blank -%}
              <a href="{{ block.settings.link }}">
            {%- endif -%}
            {%- if block.settings.image != blank -%}
              <img
                src="{{ block.settings.image | image_url: width: 640 }}"
                alt="{{ block.settings.name }}"
                loading="lazy"
              >
            {%- else -%}
              <img
                src="{{ 'accessory/' | append: forloop.index | append: '.png' | asset_url }}"
                alt="{{ block.settings.name }}"
                loading="lazy"
              >
            {%- endif -%}
            {%- if block.settings.link != blank -%}
              </a>
            {%- endif -%}
          </div>
        {% endfor %}

        <!-- Right Spacer -->
        <div class="accessory-img-spacer">&nbsp;</div>
      </div>
    </div>

    <!-- Content Container -->
    <div class="accessory-content">
      <div class="accessory-content-track">
        {% for block in section.blocks %}
          <div class="accessory-content-item">
            <h3 class="accessory-title">{{ block.settings.name }}</h3>
            <p class="accessory-text">{{ block.settings.description }}</p>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="accessory-switcher">
      <!-- Previous Button -->
      <button class="nav-button nav-prev" data-direction="prev" aria-label="Previous Accessory">
        <img src="{{ 'icon-previous.svg' | asset_url }}" alt="Previous" class="nav-icon nav-icon-active">
        <img src="{{ 'icon-previous-disable.svg' | asset_url }}" alt="Previous (Disabled)" class="nav-icon nav-icon-disable">
      </button>

      <!-- Next Button -->
      <button class="nav-button nav-next" data-direction="next" aria-label="Next Accessory">
        <img src="{{ 'icon-next.svg' | asset_url }}" alt="Next" class="nav-icon nav-icon-active">
        <img src="{{ 'icon-next-disable.svg' | asset_url }}" alt="Next (Disabled)" class="nav-icon nav-icon-disable">
      </button>
    </div>
  </div>

  <!-- View All Button Container -->
  <div class="accessory-view-all-container">
    <a href="{{ section.settings.view_all_link }}" class="accessory-view-all">View All</a>
  </div>
</div>

<script>
(function() {
  function initAccessory() {
    const section = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!section) {
      requestAnimationFrame(initAccessory);
      return;
    }

    const prevBtn = section.querySelector('.nav-prev');
    const nextBtn = section.querySelector('.nav-next');
    const imgsContainer = section.querySelector('.accessory-imgs');
    const imgTrack = section.querySelector('.accessory-imgs-track');
    const contentContainer = section.querySelector('.accessory-content');
    const contentTrack = contentContainer.querySelector('.accessory-content-track');
    const imgItems = imgTrack ? Array.from(imgTrack.querySelectorAll('.accessory-img')) : [];
    const totalItems = imgItems.length;

    if (!prevBtn || !nextBtn || !imgsContainer || !imgTrack || !contentContainer || !contentTrack || totalItems === 0) {
      return;
    }

    let currentIndex = 0;
    let isAnimating = false;

    // Get scale factor
    function getScaleFactor() {
      const value = getComputedStyle(section).getPropertyValue('--scale-factor-mobile').trim();
      return parseFloat(value) || 1;
    }

    // Get item widths from actual DOM elements
    function getItemWidths() {
      const scaleFactor = getScaleFactor();
      
      // 优先使用实际 DOM 元素的宽度
      const firstContentItem = contentTrack.querySelector('.accessory-content-item');
      const contentWidth = firstContentItem ? firstContentItem.offsetWidth : 
        parseFloat(getComputedStyle(section).getPropertyValue('--content-width').trim()) * scaleFactor;
      
      // 图片宽度仍使用 CSS 计算（用于样式控制，不影响滑动距离）
      const imgCenterWidth = parseFloat(getComputedStyle(section).getPropertyValue('--img-center-width').trim()) * scaleFactor;
      const imgSideWidth = parseFloat(getComputedStyle(section).getPropertyValue('--img-side-width').trim()) * scaleFactor;
      const imgGap = parseFloat(getComputedStyle(section).getPropertyValue('--img-gap').trim()) * scaleFactor;

      return {
        imgCenterWidth,
        imgSideWidth,
        imgGap,
        contentWidth
      };
    }

    // Update button states
    function updateButtons() {
      prevBtn.classList.toggle('disabled', currentIndex === 0);
      nextBtn.classList.toggle('disabled', currentIndex >= totalItems - 1);
    }

    // Update image states
    function updateImageStates() {
      imgItems.forEach((img, index) => {
        img.classList.remove('is-center', 'is-side', 'is-hidden', 'is-left', 'is-right');

        if (index === currentIndex) {
          img.classList.add('is-center');
        } else if (index === currentIndex - 1 || index === currentIndex + 1) {
          img.classList.add('is-side');
          img.classList.add(index < currentIndex ? 'is-left' : 'is-right');
        } else {
          img.classList.add('is-hidden');
        }
      });
    }

    function setContentOffset(index, animate = true) {
      const widths = getItemWidths();
      const translate = index * widths.contentWidth;
      if (!animate) {
        contentTrack.style.transition = 'none';
      }
      contentTrack.style.transform = `translateX(-${translate}px)`;
      if (!animate) {
        // Force reflow
        void contentTrack.offsetWidth;
        contentTrack.style.transition = '';
      }
    }

    function goToIndex(index) {
      if (index < 0 || index >= totalItems || isAnimating || index === currentIndex) {
        return;
      }

      isAnimating = true;
      currentIndex = index;

      updateButtons();
      updateImageStates();

      // 使用 scrollTo 替代 scrollIntoView，避免触发页面滚动
      const targetImg = imgItems[index];
      if (targetImg) {
        const containerCenter = imgsContainer.offsetWidth / 2;
        const imgCenter = targetImg.offsetLeft + targetImg.offsetWidth / 2;
        imgsContainer.scrollTo({
          left: imgCenter - containerCenter,
          behavior: 'smooth'
        });
      }

      // Sync content
      setContentOffset(currentIndex, true);

      // Reset animation flag after scroll completes
      setTimeout(() => {
        isAnimating = false;
      }, 500);
    }

    function jumpToIndex(index) {
      if (index < 0 || index >= totalItems) {
        return;
      }

      currentIndex = index;
      updateButtons();
      updateImageStates();

      // 使用 scrollLeft 替代 scrollIntoView，避免触发页面滚动
      const targetImg = imgItems[index];
      if (targetImg) {
        const containerCenter = imgsContainer.offsetWidth / 2;
        const imgCenter = targetImg.offsetLeft + targetImg.offsetWidth / 2;
        imgsContainer.scrollLeft = imgCenter - containerCenter;
      }

      setContentOffset(currentIndex, false);
    }

    // Initialize
    imgsContainer.scrollLeft = 0; // 重置滚动位置，防止浏览器恢复滚动状态
    updateButtons();
    updateImageStates();
    jumpToIndex(0);

    // Button click handlers
    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        goToIndex(currentIndex - 1);
      }
    });

    nextBtn.addEventListener('click', () => {
      if (currentIndex < totalItems - 1) {
        goToIndex(currentIndex + 1);
      }
    });

    window.addEventListener('resize', () => {
      jumpToIndex(currentIndex);
    });

    // Handle manual scroll
    let scrollRAF = null;
    imgsContainer.addEventListener('scroll', () => {
      if (isAnimating) return; // Wait for button animation to complete

      if (scrollRAF) cancelAnimationFrame(scrollRAF);
      scrollRAF = requestAnimationFrame(() => {
        // Calculate which image is currently centered
        const scrollLeft = imgsContainer.scrollLeft;
        const containerWidth = imgsContainer.offsetWidth;
        const containerCenter = scrollLeft + containerWidth / 2;

        // Find the closest image to the container center
        let newIndex = 0;
        let minDistance = Infinity;

        imgItems.forEach((img, index) => {
          const imgLeft = img.offsetLeft;
          const imgCenter = imgLeft + img.offsetWidth / 2;
          const distance = Math.abs(containerCenter - imgCenter);

          if (distance < minDistance) {
            minDistance = distance;
            newIndex = index;
          }
        });

        // Only update if index actually changed
        if (newIndex !== currentIndex) {
          currentIndex = newIndex;
          updateButtons();
          updateImageStates();
          setContentOffset(currentIndex, true);
        }

        scrollRAF = null;
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAccessory);
  } else {
    initAccessory();
  }
})();
</script>

{% schema %}
{
  "name": "Custom Accessory",
  "settings": [
    {
      "type": "textarea",
      "id": "title",
      "label": "Title"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "text",
      "id": "view_all_link",
      "label": "View All Link"
    }
  ],
  "blocks": [
    {
      "type": "accessory_item",
      "name": "Accessory Item",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "name",
          "label": "Name"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Product Link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Accessory"
    }
  ]
}
{% endschema %}
