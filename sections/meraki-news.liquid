{{ 'meraki-common.css' | asset_url | stylesheet_tag }}
{{ 'meraki-news.css' | asset_url | stylesheet_tag }}

<div class="meraki-news design-scale" data-section-id="{{ section.id }}">
  <!-- Header: Title & Navigation -->
  <div class="news-header">
    <h2 class="section-title news-title">{{ section.settings.heading }}</h2>
    
    <!-- Navigation Switcher (Desktop only) -->
    <div class="news-nav-switcher">
      <button class="news-nav-button news-nav-prev" aria-label="Previous">
        <img class="news-nav-icon news-nav-icon-active" src="{{ 'icon-previous.svg' | asset_url }}" alt="" width="60" height="60">
        <img class="news-nav-icon news-nav-icon-disable" src="{{ 'icon-previous-disable.svg' | asset_url }}" alt="" width="60" height="60">
      </button>
      <button class="news-nav-button news-nav-next" aria-label="Next">
        <img class="news-nav-icon news-nav-icon-active" src="{{ 'icon-next.svg' | asset_url }}" alt="" width="60" height="60">
        <img class="news-nav-icon news-nav-icon-disable" src="{{ 'icon-next-disable.svg' | asset_url }}" alt="" width="60" height="60">
      </button>
    </div>
  </div>

  <!-- News Cards Container -->
  <div class="news-cards-container">
    <!-- News Cards Track -->
    <div class="news-cards-track">
      <!-- Spacer (Desktop only) -->
      <div class="news-card news-card-spacer">&nbsp;</div>
      
    {%- if section.settings.blog != blank and section.settings.blog.articles_count > 0 -%}
      {%- for article in section.settings.blog.articles limit: 5 -%}
        <div class="news-card">
          <!-- Card Image -->
          {%- if section.settings.show_image and article.image -%}
            <a href="{{ article.url }}" class="news-card-image-link">
              <div class="news-card-image">
                <img
                  src="{{ article.image | image_url: width: 690 }}"
                  srcset="{{ article.image | image_url: width: 345 }} 345w,
                          {{ article.image | image_url: width: 690 }} 690w"
                  sizes="(min-width: 990px) 345px, 345px"
                  alt="{{ article.image.alt | escape }}"
                  loading="lazy"
                  width="345"
                  height="380"
                >
              </div>
            </a>
          {%- endif -%}

          <!-- Card Content -->
          <div class="news-card-content">
            <!-- Title -->
            <h3 class="news-card-title">
              {{ article.title | escape }}
            </h3>

            <!-- Excerpt -->
            {%- if section.settings.show_excerpt -%}
              <p class="news-card-excerpt">
                {%- if article.excerpt.size > 0 -%}
                  {{ article.excerpt | strip_html }}
                {%- else -%}
                  {{ article.content | strip_html | truncatewords: 20 }}
                {%- endif -%}
              </p>
            {%- endif -%}

            <!-- Footer: Date & Read More -->
            <div class="news-card-footer">
              {%- if section.settings.show_date -%}
                <span class="news-card-date">
                  {{ article.published_at | date: "%b %d, %Y" }}
                </span>
              {%- endif -%}
              <a href="{{ article.url }}" class="news-card-link">Read more</a>
            </div>
          </div>
        </div>
      {%- endfor -%}
    {%- else -%}
      <!-- Placeholder cards when no blog is selected -->
      {%- for i in (1..4) -%}
        <div class="news-card news-card-placeholder">
          <div class="news-card-image">
            <div class="news-card-placeholder-image">
              {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
            </div>
          </div>
          <div class="news-card-content">
            <h3 class="news-card-title">
              Meraki Autumn Recipes: Craft Your Seasonal ...
            </h3>
            <p class="news-card-excerpt">
              Meraki Autumn Recipes: Craft Your Seasonal Meraki Autumn...
            </p>
            <div class="news-card-footer">
              <span class="news-card-date">Apr 11, 2025</span>
              <a href="#" class="news-card-link">Read more</a>
            </div>
          </div>
        </div>
      {%- endfor -%}
    {%- endif -%}
      
      <!-- Spacer (Desktop only) -->
      <div class="news-card news-card-spacer">&nbsp;</div>
    </div>
  </div>

  <!-- View All Button -->
  {%- if section.settings.show_view_all -%}
    <div class="news-view-all-container">
      {%- if section.settings.view_all_link != blank -%}
        <a href="{{ section.settings.view_all_link }}" class="news-view-all">View All</a>
      {%- elsif section.settings.blog != blank -%}
        <a href="{{ section.settings.blog.url }}" class="news-view-all">View All</a>
      {%- endif -%}
    </div>
  {%- endif -%}
</div>

<script>
(function() {
  function initNewsCarousel() {
    const section = document.querySelector('.meraki-news[data-section-id="{{ section.id }}"]');
    if (!section) {
      requestAnimationFrame(initNewsCarousel);
      return;
    }

    if (!window.MerakiCarousel) {
      console.error('MerakiCarousel not loaded');
      return;
    }

    const track = section.querySelector('.news-cards-track');
    const cards = section.querySelectorAll('.news-card:not(.news-card-spacer)');
    const prevButton = section.querySelector('.news-nav-prev');
    const nextButton = section.querySelector('.news-nav-next');

    if (!track || cards.length === 0 || !prevButton || !nextButton) return;

    // 使用 MerakiCarousel 组件
    new MerakiCarousel({
      container: section,
      track: track,
      items: cards,
      prevButton: prevButton,
      nextButton: nextButton,
      
      // 使用 slide 模式
      mode: 'slide',
      
      // 动态计算 itemWidth（card + gap）
      itemWidth: function(scale) {
        if (window.innerWidth >= 990) {
          return (580 + 40) * scale; // 桌面端：card 580px + gap 40px
        }
        return 0;
      },
      
      // Gap
      gap: 40,
      
      // 动态计算初始偏移（spacer 设计）
      initialOffset: function() {
        if (window.innerWidth >= 990) {
          const scaleFactor = parseFloat(getComputedStyle(section).getPropertyValue('--scale-factor-desktop').trim()) || 1;
          return -260 * scaleFactor; // spacer 初始偏移
        }
        return 0;
      },
      
      // 动态计算可见 items 数量
      itemsVisible: function() {
        if (window.innerWidth >= 990) {
          const container = section.querySelector('.news-cards-container');
          if (container) {
            const containerWidth = container.offsetWidth;
            const scaleFactor = parseFloat(getComputedStyle(section).getPropertyValue('--scale-factor-desktop').trim()) || 1;
            const cardWidth = 620 * scaleFactor; // 580 + 40
            return Math.floor(containerWidth / cardWidth);
          }
          return 3; // 默认显示 3 个
        }
        return 1;
      },
      
      // 仅桌面端启用
      desktopOnly: true,
      
      // 不启用触摸手势
      enableTouch: false
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNewsCarousel);
  } else {
    initNewsCarousel();
  }
})();
</script>

{% schema %}
{
  "name": "Meraki News",
  "settings": [
    {
      "type": "blog",
      "id": "blog",
      "label": "Blog"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Latest News"
    },
    {
      "type": "checkbox",
      "id": "show_image",
      "label": "Show featured image",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_date",
      "label": "Show date",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_excerpt",
      "label": "Show excerpt",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show view all button",
      "default": true
    },
    {
      "type": "url",
      "id": "view_all_link",
      "label": "View all link",
      "info": "Custom URL for the view all button. Leave blank to use blog URL."
    }
  ],
  "presets": [
    {
      "name": "Meraki News"
    }
  ]
}
{% endschema %}


