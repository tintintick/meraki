{{ 'subscription-popup.css' | asset_url | stylesheet_tag }}

{%- comment -%} Get More Info Button (Mobile) {%- endcomment -%}
<button
  class="header__icon header__icon--info link focus-inset"
  id="header-get-more-info-mobile"
  aria-label="Get more info"
  type="button"
>
  <span class="header__info-icon">
    {{- 'header/ring.svg' | inline_asset_content -}}
  </span>
</button>

{%- comment -%} Get More Info Button (Desktop) {%- endcomment -%}
<button
  class="header__icon header__icon--info link focus-inset"
  id="header-get-more-info"
  aria-label="Get more info"
  type="button"
>
  <span class="header__info-text">Get more info</span>
  <span class="header__info-cross">
    {{- 'header/cross.svg' | inline_asset_content -}}
  </span>
</button>

{%- comment -%} Subscription Popup {%- endcomment -%}
<div id="subscription-popup" class="subscription-popup hidden">
  <div class="popup-image">
    <picture>
      {%- if popup_image != blank -%}
        <source
          srcset="{{ popup_image | image_url: width: 710 }}"
          media="(min-width: 700px)"
          width="355"
          height="299"
        >
        <img
          src="{{ popup_image | image_url: width: 340 }}"
          alt="Meraki Coffee Machine"
          width="170"
          height="212"
          loading="lazy"
        >
      {%- else -%}
        <source
          srcset="{{ 'header/popup.webp' | asset_url }}"
          media="(min-width: 700px)"
        >
        <img
          src="{{ 'header/popup.webp' | asset_url }}"
          alt="Meraki Coffee Machine"
          width="170"
          height="212"
          loading="lazy"
        >
      {%- endif -%}
    </picture>
  </div>
  <button class="popup-close" aria-label="Close popup" type="button">
    <svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M18.4519 6L6.4519 18" stroke="#393939" stroke-width="2" stroke-linecap="square" stroke-linejoin="round"></path>
      <path d="M6.4519 6L18.4519 18" stroke="#393939" stroke-width="2" stroke-linecap="square" stroke-linejoin="round"></path>
    </svg>
  </button>
  <div class="popup-content">
    <div>
      <h2 class="popup-title">Welcome to Meraki</h2>
      <div class="popup-desc">Subscribe for updates & offers</div>
    </div>
    {% form 'customer', id: 'subscription-popup-form', class: 'subscription-popup-form' %}
      <input type="hidden" name="contact[tags]" value="newsletter">
      <div class="popup-form-row">
        <input
          type="email"
          name="contact[email]"
          id="PopupEmail-{{ section_id }}"
          class="popup-input"
          value="{{ form.email }}"
          aria-required="true"
          autocorrect="off"
          autocapitalize="off"
          autocomplete="email"
          placeholder="Enter your email"
          required
          {% if form.errors %}
            aria-invalid="true"
            aria-describedby="PopupNewsletter-error-{{ section_id }}"
          {% elsif form.posted_successfully? %}
            aria-describedby="PopupNewsletter-success-{{ section_id }}"
          {% endif %}
        >
        <button type="submit" class="popup-submit popup-submit--subscribe">
          Subscribe now
        </button>
        <button type="button" class="popup-submit popup-submit--success hidden" tabindex="-1" aria-hidden="true">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M26.6667 8L12 22.6667L5.33334 16" stroke="white" stroke-width="3" stroke-linecap="square"></path>
          </svg>
        </button>
      </div>
      {%- if form.errors -%}
        <small class="popup-message popup-message--error" id="PopupNewsletter-error-{{ section_id }}">
          <span class="svg-wrapper">
            <svg class="icon icon-error" viewBox="0 0 13 13">
              <circle cx="6.5" cy="6.5" r="5.5" stroke="#fff" stroke-width="2"></circle>
              <circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width=".7"></circle>
              <path fill="#fff" d="m5.874 3.528.1 4.044h1.053l.1-4.044zm.627 6.133c.38 0 .68-.288.68-.656s-.3-.656-.68-.656-.681.288-.681.656.3.656.68.656"></path>
              <path fill="#fff" stroke="#EB001B" stroke-width=".7" d="M5.874 3.178h-.359l.01.359.1 4.044.008.341h1.736l.008-.341.1-4.044.01-.359H5.873Zm.627 6.833c.56 0 1.03-.432 1.03-1.006s-.47-1.006-1.03-1.006-1.031.432-1.031 1.006.47 1.006 1.03 1.006Z"></path>
            </svg>
          </span>
          <span class="error-text">{{ form.errors | default_errors }}</span>
        </small>
      {%- endif -%}
      {%- if form.posted_successfully? -%}
        <div class="popup-message popup-message--success hidden" id="PopupNewsletter-success-{{ section_id }}" tabindex="-1">
          <span class="success-icon">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M26.6667 8L12 22.6667L5.33334 16" stroke="white" stroke-width="3" stroke-linecap="square"></path>
            </svg>
          </span>
          <span class="success-text">Thank you for subscribing!</span>
        </div>
      {%- endif -%}
    {% endform %}
    <div class="popup-terms">
      <p>By signing up, you agree to Meraki's <a href="https://www.merakitech.com/pages/term-of-service" target="_blank" title="Term of Service">Terms of Service</a> and <a href="https://www.merakitech.com/pages/privacy-policy" target="_blank" title="Privacy Policy">Privacy Policy</a>.</p>
    </div>
  </div>
</div>

{% javascript %}
  // Subscription Popup Logic
  (function() {
    const popup = document.getElementById('subscription-popup');
    const openButtonDesktop = document.getElementById('header-get-more-info');
    const openButtonMobile = document.getElementById('header-get-more-info-mobile');
    const closeButton = popup?.querySelector('.popup-close');
    const crossButton = openButtonDesktop?.querySelector('.header__info-cross');
    const form = popup?.querySelector('#subscription-popup-form');
    const submitButton = popup?.querySelector('.popup-submit--subscribe');
    const successButton = popup?.querySelector('.popup-submit--success');
    const errorMessage = popup?.querySelector('.popup-message--error');

    if (!popup) return;

    let savedScrollPosition = 0;
    let scrollHandler = null;

    function openPopup() {
      popup.classList.remove('hidden');
      
      // Desktop: keep scrollbar visible, prevent scrolling
      // Mobile: hide scrollbar
      if (window.innerWidth >= 990) {
        // Desktop - preserve scrollbar
        savedScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
        document.body.style.overflowY = 'scroll';
        document.body.style.position = 'fixed';
        document.body.style.top = `-${savedScrollPosition}px`;
        document.body.style.width = '100%';
        
        // Prevent scrolling with wheel/touch events
        scrollHandler = (e) => {
          e.preventDefault();
          e.stopPropagation();
        };
        document.body.addEventListener('wheel', scrollHandler, { passive: false });
        document.body.addEventListener('touchmove', scrollHandler, { passive: false });
      } else {
        // Mobile - hide scrollbar
        const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
        document.body.style.overflow = 'hidden';
        document.body.style.paddingRight = scrollbarWidth + 'px';
      }
    }

    function closePopup() {
      popup.classList.add('hidden');
      
      // Restore scrolling based on viewport
      if (window.innerWidth >= 990) {
        // Desktop - restore scroll position
        document.body.style.overflowY = '';
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.width = '';
        window.scrollTo(0, savedScrollPosition);
        
        // Remove scroll prevention
        if (scrollHandler) {
          document.body.removeEventListener('wheel', scrollHandler);
          document.body.removeEventListener('touchmove', scrollHandler);
          scrollHandler = null;
        }
      } else {
        // Mobile - restore overflow
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      }
      
      // Reset form
      if (form) {
        form.reset();
        if (errorMessage) {
          errorMessage.classList.add('hidden');
        }
        if (submitButton) submitButton.classList.remove('hidden');
        if (successButton) successButton.classList.add('hidden');
      }
    }

    function hideGetMoreInfoButton() {
      if (openButtonDesktop) {
        openButtonDesktop.style.display = 'none';
      }
    }

    // Handle cross button click - hide the button
    if (crossButton) {
      crossButton.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent triggering the button's click event
        hideGetMoreInfoButton();
      });
    }

    // Open popup - handle both desktop and mobile buttons
    if (openButtonDesktop) {
      openButtonDesktop.addEventListener('click', (e) => {
        // Don't open popup if clicking on the cross
        if (e.target.closest('.header__info-cross')) {
          e.preventDefault();
          hideGetMoreInfoButton();
          return;
        }
        openPopup();
      });
    }
    if (openButtonMobile) {
      openButtonMobile.addEventListener('click', openPopup);
    }

    // Close popup
    if (closeButton) {
      closeButton.addEventListener('click', closePopup);
    }

    // Close on outside click
    popup.addEventListener('click', (e) => {
      if (e.target === popup) {
        closePopup();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !popup.classList.contains('hidden')) {
        closePopup();
      }
    });

    // Form submission - AJAX submit like custom-subscribe
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const emailInput = form.querySelector('.popup-input');
        const email = emailInput?.value.trim();

        if (!email) {
          if (errorMessage) {
            errorMessage.querySelector('.error-text').textContent = 'Please enter a valid email address.';
            errorMessage.classList.remove('hidden');
          }
          return;
        }

        // Show loading state
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = 'Subscribing...';
        }

        // Submit via AJAX to current page (like custom-subscribe)
        try {
          const formData = new FormData(form);
          // Add accepts_marketing for customer form
          formData.append('contact[accepts_marketing]', 'true');
          
          const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });

          const html = await response.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          
          // Check for form errors or success messages in the response
          const formSection = doc.querySelector('#subscription-popup-form, .subscription-popup-form');
          const errorElement = formSection?.querySelector('.popup-message--error, .form__message, [class*="error"]');
          const successElement = formSection?.querySelector('.popup-message--success, [class*="success"]');
          
          // Also check for general form errors
          const generalError = doc.querySelector('.form__message:not([class*="success"])');

          if (errorElement || generalError || (!successElement && !response.ok)) {
            // Show error
            if (errorMessage) {
              const errorText = errorElement?.querySelector('.error-text')?.textContent?.trim() 
                || errorElement?.textContent?.trim() 
                || generalError?.textContent?.trim() 
                || 'Something went wrong. Please try again.';
              errorMessage.querySelector('.error-text').textContent = errorText;
              errorMessage.classList.remove('hidden');
              emailInput.setAttribute('aria-invalid', 'true');
            }
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.textContent = 'Subscribe now';
            }
          } else {
            // Show success state
            if (submitButton) submitButton.classList.add('hidden');
            if (successButton) successButton.classList.remove('hidden');
            if (errorMessage) errorMessage.classList.add('hidden');
            emailInput.removeAttribute('aria-invalid');
            
            // Close popup after 2 seconds
            setTimeout(() => {
              closePopup();
            }, 2000);
          }
        } catch (error) {
          // Network or parsing error
          if (errorMessage) {
            errorMessage.querySelector('.error-text').textContent = 'Something went wrong. Please try again.';
            errorMessage.classList.remove('hidden');
          }
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Subscribe now';
          }
        }
      });
    }
  })();
{% endjavascript %}

